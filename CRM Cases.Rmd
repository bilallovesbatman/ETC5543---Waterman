---
title: "Customer Retention - CRM Cases"
author: "Bilal Raja"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
library(tidyverse)
library(readxl)
library(visdat)
library(pROC)
library(caret)
```

## Load Data

```{r, warning=FALSE}
wmcases <- read_xlsx("data/CRM Cases 1-08-2024 5-17-55 PM.xlsx")
memberships <- read_xlsx("data/All Products 2023 to now.xlsx")
```

## Inspecting the Data

```{r}
vis_dat(wmcases)
vis_miss(wmcases)
```

```{r}
vis_dat(memberships)
vis_miss(memberships)
```

## Wrangling the Data

### Clean and Check for NAs

```{r}
cases_clean <- wmcases |>
  filter(!grepl("Product delivery", Subject, ignore.case = TRUE) &
           !grepl("ETC waiver", Subject, ignore.case = TRUE) &
           !grepl("Financial request", Subject, ignore.case = TRUE) &
           !grepl("Purchase orders", Subject, ignore.case = TRUE) &
           !grepl("Rent/Membership assistance", Subject, ignore.case = TRUE) &
           !grepl("All retired ones", Subject, ignore.case = TRUE) &
           !grepl("\\(RETIRED\\)", Subject, ignore.case = TRUE)) |>    #Based on supervisor's requirement
  filter(!is.na(`Account Number (Customer) (Account)`)) |>
  rename(`Account Number` = `Account Number (Customer) (Account)`) |>  #Rename the column
  select(-`(Do Not Modify) Case`,
         -`(Do Not Modify) Row Checksum`,
         -`(Do Not Modify) Modified On`)
```

```{r}
member_clean <- memberships |>
  filter(!grepl("Quote Duplicate", `Status Reason`, ignore.case = TRUE)) |>
  filter(!grepl("Casual Hire", `Accounting Code`, ignore.case = TRUE)) |>
  filter(!is.na(`Account Number (Lessee) (Account)`)) |>
  rename(`Account Number` = `Account Number (Lessee) (Account)`)
```

```{r}
vis_miss(cases_clean)
vis_miss(member_clean)
```

### Join the Datasets

```{r}
cases_joined <- left_join(cases_clean, member_clean, 
                                 by = "Account Number")
```

```{r}
names(cases_joined)
```
### Rearrange

```{r}
cases_joined <- cases_joined |>
  select(`Account Number`, 
         `Customer`,
         `Case Number`, 
         `Case Title`, 
         `Case Age`, 
         `Case Age (Days)`, 
         `Is Escalated`, 
         everything(),
         -Priority,
         -`Modified On`,
         -Satisfaction,
         -`Sentiment Value`,
         -`Service Level`,
         -SLA,
         -Severity,
         -Status.y,
         -`Product Name`,
         -Location,
         -`Accounting Code`,
         -`Status Reason.x`,
         -`Industry (Lessee) (Account)`,
         -Lessee) |>
  filter(!grepl("TestPayment", `Account Number`, ignore.case = TRUE)) |>
  filter(!grepl("Waterman Workspaces", `Customer`, ignore.case = TRUE))
```

## Defining Churn Statuses

```{r}
churn_statuses <- c("Inactive - Customer Cancelled", "Off-boarding", "Inactive")

cases_filtered <- cases_joined |>
  filter(`Status Reason.y` %in% churn_statuses | is.na(`Status Reason.y`)) |>
  mutate(`Is Escalated` = ifelse(`Is Escalated` == "Yes", 1, 0))
```

## TRIALING FEATURE ENGINEERING

```{r}
cases_count <- cases_filtered |>
  group_by(`Account Number`) |>
  summarise(num_cases = n())

cases_count

```

```{r}
avg_case_age <- cases_filtered |>
  group_by(`Account Number`) |>
  summarise(avg_case_age = median(`Case Age (Days)`, na.rm = TRUE))

avg_case_age
```

```{r}
customer_features <- cases_count |>
  inner_join(avg_case_age, by = "Account Number")
```

```{r}
customer_features <- cases_filtered |>
  group_by(`Account Number`) |>
  summarise(
    num_cases = n(),
    avg_case_age = median(`Case Age (Days)`, na.rm = TRUE),
    churned = as.integer(any(`Status Reason.y` %in% churn_statuses)),
    product_category = first(`Product Category`),  # or use mode if there's variability
    is_escalated = max(`Is Escalated`)              # Use max since it's already binary
  )

```

```{r}
ggplot(customer_features, aes(x = num_cases, fill = as.factor(churned))) +
  geom_histogram(position = "dodge", binwidth = 1) +
  labs(title = "Distribution of Number of Cases", x = "Number of Cases", fill = "Churned")

ggplot(customer_features, aes(x = avg_case_age, fill = as.factor(churned))) +
  geom_histogram(position = "dodge", binwidth = 1) +
  labs(title = "Distribution of Average Case Age", x = "Average Case Age (Days)", fill = "Churned")

```
## Remove Outliers

```{r}
Q1_age <- quantile(customer_features$avg_case_age, 0.25, na.rm = TRUE)
Q3_age <- quantile(customer_features$avg_case_age, 0.75, na.rm = TRUE)
IQR_age <- Q3_age - Q1_age

```

```{r}
lower_bound_age <- Q1_age - 1.5 * IQR_age
upper_bound_age <- Q3_age + 1.5 * IQR_age

```

```{r}
outliers_age <- customer_features |>
  filter(avg_case_age < lower_bound_age | avg_case_age > upper_bound_age)

customer_features_clean <- customer_features |>
  filter(avg_case_age >= lower_bound_age & avg_case_age <= upper_bound_age)

```

```{r}
Q1_num <- quantile(customer_features$num_cases, 0.25, na.rm = TRUE)
Q3_num <- quantile(customer_features$num_cases, 0.75, na.rm = TRUE)
IQR_num <- Q3_num - Q1_num

```

```{r}
lower_bound_num <- Q1_num - 1.5 * IQR_num
upper_bound_num <- Q3_num + 1.5 * IQR_num

```

```{r}
outliers_num <- customer_features_clean |>
  filter(num_cases < lower_bound_num | num_cases > upper_bound_num)

customer_features_clean <- customer_features_clean |>
  filter(num_cases >= lower_bound_num & num_cases <= upper_bound_num)

```

```{r}
ggplot(customer_features_clean, aes(x = num_cases, fill = as.factor(churned))) +
  geom_histogram(position = "dodge", binwidth = 1) +
  labs(title = "Distribution of Number of Cases", x = "Number of Cases", fill = "Churned")

ggplot(customer_features_clean, aes(x = avg_case_age, fill = as.factor(churned))) +
  geom_histogram(position = "dodge", binwidth = 1) +
  labs(title = "Distribution of Average Case Age", x = "Average Case Age (Days)", fill = "Churned")
```

```{r}
cor(customer_features_clean |> select(num_cases, avg_case_age, is_escalated, churned))

```

## Modeling

### Overall Average

```{r}
age_benchmark <- mean(customer_features_clean$avg_case_age)

customer_features_clean <- customer_features_clean |>
  mutate(case_age_ratio = avg_case_age / age_benchmark)
```


### Lm

```{r}
linear <- lm(churned ~ num_cases + case_age_ratio + is_escalated, data = customer_features_clean)
summary(linear)
```
### Logistic Regression

```{r}
log_model <- glm(churned ~ num_cases + case_age_ratio + is_escalated, data = customer_features_clean, family = binomial)
summary(log_model)

```

## Preliminary Analysis

```{r}
summary(cases_joined)
```

```{r}
table(cases_joined$Status.x)
```

```{r}
ggplot(cases_joined, aes(
  x = Status.x, 
  y = `Case Age (Days)`,
  fill = Status.x
)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Case Age by Stats",
       x = "Case Status",
       y = "Case Age (Days)")
```

```{r}
# Define the statuses indicating customer churn
churn_statuses <- c("Inactive - Customer Cancelled", "Off-boarding", "Inactive")

# Filter the dataset for customers who left
cases_summary <- cases_joined %>%
  filter(`Status Reason.y` %in% churn_statuses) %>%
  group_by(`Account Number`, Customer, `Status Reason.y`) %>%
  summarize(
    total_cases = n(),
    avg_case_age = mean(`Case Age (Days)`, na.rm = TRUE),
    .groups = 'drop'
  )

# View the summarized data of customers who left
head(cases_summary)

```

```{r}

sum(is.na(cases_summary$total_cases))
sum(is.na(cases_summary$avg_case_age))

cases_summary_clean <- cases_summary %>%
  filter(!is.na(total_cases) & !is.na(avg_case_age))



# Summary statistics for churned customers
summary_stats <- cases_summary_clean %>%
  summarize(
    avg_total_cases = mean(total_cases, na.rm = TRUE),
    median_total_cases = median(total_cases, na.rm = TRUE),
    avg_case_age = mean(avg_case_age, na.rm = TRUE),
    median_case_age = median(avg_case_age, na.rm = TRUE),
    cor_cases_age = cor(total_cases, avg_case_age, use = "complete.obs")
  )

print(summary_stats)

```

```{r}
ggplot(cases_summary, aes(x = total_cases)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Number of Cases for Churned Customers",
       x = "Number of Cases",
       y = "Count of Customers")

```
```{r}
ggplot(cases_summary, aes(x = "", y = avg_case_age)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Case Resolution Time for Churned Customers",
       y = "Average Case Age (Days)") +
  theme(axis.text.x = element_blank())
```


### Remove Outliers

```{r}

Q1 <- quantile(cases_joined$`Case Age (Days)`, 0.25)
Q3 <- quantile(cases_joined$`Case Age (Days)`, 0.75)
IQR <- Q3 - Q1

cases_rmoutlier <- cases_joined |>
  filter(`Case Age (Days)` >= (Q1 - 1.5 * IQR) & `Case Age (Days)` <= (Q3 + 1.5 * IQR))
```


```{r}
ggplot(cases_rmoutlier, aes(
  x = Status.x, 
  y = `Case Age (Days)`,
  fill = Status.x
)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Case Age by Stats",
       x = "Case Status",
       y = "Case Age (Days)")
```

```{r}
cases_rmoutlier |>
  group_by(Status.x) |>
  summarise(Count = n(),
            Mean_Age = mean(`Case Age (Days)`, na.rm = TRUE),
            Prop_Leaving = mean(`Status Reason` == "Off-boarding", na.rm = TRUE))
```

```{r}
glm_model <- lm(`Status Reason` == "Off-boarding" ~ Status.x + `Case Age (Days)` + `Is Escalated`, 
                  data = cases_rmoutlier, family = binomial)
summary(glm_model)

```

```{r}
# Load necessary libraries
library(ggplot2)
library(broom)

# Create a tidy data frame of model coefficients
tidy_glm <- broom::tidy(glm_model)

# Create a coefficient plot
ggplot(tidy_glm, aes(x = estimate, y = term)) +
  geom_point() +
  geom_errorbarh(aes(xmin = estimate - std.error, xmax = estimate + std.error), height = 0.2) +
  labs(title = "Coefficient Plot",
       x = "Estimate",
       y = "Predictor Variables") +
  theme_minimal()

```

```{r}
# Step 1: Filter out rows with missing values in relevant columns
filtered_cases <- cases_rmoutlier %>%
  filter(!is.na(`Status Reason`) & !is.na(Status.x) & !is.na(`Case Age (Days)`) & !is.na(`Is Escalated`))

# Step 2: Fit the model again with the filtered data
glm_model <- glm(`Status Reason` == "Off-boarding" ~ Status.x + `Case Age (Days)` + `Is Escalated`, 
                 data = filtered_cases, family = binomial)

# Step 3: Generate predicted probabilities
filtered_cases$predicted_prob <- predict(glm_model, type = "response")

# Step 4: Create the regression plot
ggplot(filtered_cases, aes(x = `Case Age (Days)`, y = predicted_prob, color = Status.x)) +
  geom_point(alpha = 0.3) +  # Points for actual data
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +  # Logistic regression line
  labs(title = "Logistic Regression Plot",
       x = "Case Age (Days)",
       y = "Predicted Probability of Off-boarding",
       color = "Status") +
  theme_minimal()

```

```{r}
# Load necessary library
library(ggplot2)

# Create calibration plot
ggplot(filtered_cases, aes(x = predicted_prob, y = as.numeric(`Status Reason` == "Off-boarding"))) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess") +
  labs(title = "Calibration Plot",
       x = "Predicted Probability",
       y = "Observed Proportion") +
  theme_minimal() 
```

