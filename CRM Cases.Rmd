---
title: "Customer Retention - CRM Cases"
author: "Bilal Raja"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
library(tidyverse)
library(readxl)
library(visdat)
```

## Load Data

```{r, warning=FALSE}
wmcases <- read_xlsx("data/CRM Cases 1-08-2024 5-17-55 PM.xlsx")
memberships <- read_xlsx("data/Office and Membership subscriptions 1-08-2024 4-52-20 PM.xlsx")
accounts <- read_xlsx("data/CRM Company Accounts 1-08-2024 4-36-46 PM.xlsx")
```

## Inspecting the Data

```{r}
vis_dat(wmcases)
vis_miss(wmcases)
```

```{r}
vis_dat(memberships)
vis_miss(memberships)
```

```{r}
vis_dat(accounts)
vis_miss(accounts)
```

## Wrangling the Data

### Clean and Check for NAs

```{r}
cases_clean <- wmcases |>
  filter(!grepl("Product delivery", Subject, ignore.case = TRUE) &
           !grepl("ETC waiver", Subject, ignore.case = TRUE) &
           !grepl("Financial request", Subject, ignore.case = TRUE) &
           !grepl("Purchase orders", Subject, ignore.case = TRUE) &
           !grepl("Rent/Membership assistance", Subject, ignore.case = TRUE) &
           !grepl("All retired ones", Subject, ignore.case = TRUE) &
           !grepl("\\(RETIRED\\)", Subject, ignore.case = TRUE)) |>    #Based on supervisor's requirement
  filter(!is.na(`Account Number (Customer) (Account)`)) |>
  rename(`Account Number` = `Account Number (Customer) (Account)`) |>  #Rename the column
  select(-`(Do Not Modify) Case`,
         -`(Do Not Modify) Row Checksum`,
         -`(Do Not Modify) Modified On`)
```

```{r}
member_clean <- memberships |>
  filter(!grepl("Quote Duplicate", `Status Reason`, ignore.case = TRUE)) |>
  filter(!is.na(`Account Number (Lessee) (Account)`)) |>
  rename(`Account Number` = `Account Number (Lessee) (Account)`) |>
  select(-`(Do Not Modify) Primary Product`,
         -`(Do Not Modify) Row Checksum`,
         -`(Do Not Modify) Modified On`)
```

```{r}
accounts_clean <- accounts |>
  filter(!grepl("1a - Pre-billing", `Status Reason`, ignore.case = TRUE))|>
  filter(!is.na(`Account Number`)) |>
  select(-`(Do Not Modify) Account`, 
         -`(Do Not Modify) Row Checksum`, 
         -`(Do Not Modify) Modified On`)
```

```{r}
vis_miss(cases_clean)
vis_miss(accounts_clean)
vis_miss(member_clean)
```

### Join the Datasets

```{r}
cases_accounts_join <- left_join(cases_clean, accounts_clean, 
                                 by = "Account Number",
                                 relationship = "many-to-many")
cases_joined <- left_join(cases_accounts_join, member_clean,
                          by = "Account Number",
                          relationship = "many-to-many")
```

```{r}
names(cases_joined)
```
### Rearrange

```{r}
cases_joined <- cases_joined |>
  select(`Account Number`, 
         `Customer`,
         `Industry`,
         `Case Number`, 
         `Case Title`, 
         `Case Age`, 
         `Case Age (Days)`, 
         `Is Escalated`, 
         everything(),
         -Priority,
         -`Modified On`,
         -Satisfaction,
         -`Sentiment Value`,
         -`Service Level`,
         -SLA,
         -Severity,
         -`Status Reason.y`,
         -`Account Name`,
         -`Account Category`,
         -`Billing Method`,
         -`Billing Frequency`,
         -`Created On.x`,
         -`Account Rating`,
         -Status.y,
         -`Product Name`,
         -`Created On.y`,
         -`Contract Start Date`,
         -`Contract Expiry Date`,
         -`Product Family`,
         -Location,
         -`Accounting Code`,
         -`Status Reason.x`,
         -Lessee) |>
  filter(!grepl("TestPayment", `Account Number`, ignore.case = TRUE))
```

