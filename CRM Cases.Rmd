---
title: "Customer Retention - CRM Cases"
author: "Bilal Raja"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
library(tidyverse)
library(readxl)
library(visdat)
```

## Load Data

```{r, warning=FALSE}
wmcases <- read_xlsx("data/CRM Cases 1-08-2024 5-17-55 PM.xlsx")
memberships <- read_xlsx("data/Office and Membership subscriptions 1-08-2024 4-52-20 PM.xlsx")
accounts <- read_xlsx("data/CRM Company Accounts 1-08-2024 4-36-46 PM.xlsx")
```

## Inspecting the Data

```{r}
vis_dat(wmcases)
vis_miss(wmcases)
```

```{r}
vis_dat(memberships)
vis_miss(memberships)
```

```{r}
vis_dat(accounts)
vis_miss(accounts)
```

## Wrangling the Data

### Clean and Check for NAs

```{r}
cases_clean <- wmcases |>
  filter(!grepl("Product delivery", Subject, ignore.case = TRUE) &
           !grepl("ETC waiver", Subject, ignore.case = TRUE) &
           !grepl("Financial request", Subject, ignore.case = TRUE) &
           !grepl("Purchase orders", Subject, ignore.case = TRUE) &
           !grepl("Rent/Membership assistance", Subject, ignore.case = TRUE) &
           !grepl("All retired ones", Subject, ignore.case = TRUE) &
           !grepl("\\(RETIRED\\)", Subject, ignore.case = TRUE)) |>    #Based on supervisor's requirement
  filter(!is.na(`Account Number (Customer) (Account)`)) |>
  rename(`Account Number` = `Account Number (Customer) (Account)`) |>  #Rename the column
  select(-`(Do Not Modify) Case`,
         -`(Do Not Modify) Row Checksum`,
         -`(Do Not Modify) Modified On`)
```

```{r}
member_clean <- memberships |>
  filter(!grepl("Quote Duplicate", `Status Reason`, ignore.case = TRUE)) |>
  filter(!is.na(`Account Number (Lessee) (Account)`)) |>
  rename(`Account Number` = `Account Number (Lessee) (Account)`) |>
  select(-`(Do Not Modify) Primary Product`,
         -`(Do Not Modify) Row Checksum`,
         -`(Do Not Modify) Modified On`)
```

```{r}
accounts_clean <- accounts |>
  filter(!grepl("1a - Pre-billing", `Status Reason`, ignore.case = TRUE))|>
  filter(!is.na(`Account Number`)) |>
  select(-`(Do Not Modify) Account`, 
         -`(Do Not Modify) Row Checksum`, 
         -`(Do Not Modify) Modified On`)
```

```{r}
vis_miss(cases_clean)
vis_miss(accounts_clean)
vis_miss(member_clean)
```

### Join the Datasets

```{r}
cases_accounts_join <- left_join(cases_clean, accounts_clean, 
                                 by = "Account Number",
                                 relationship = "many-to-many")
cases_joined <- left_join(cases_accounts_join, member_clean,
                          by = "Account Number",
                          relationship = "many-to-many")
```

```{r}
names(cases_joined)
```
### Rearrange

```{r}
cases_joined <- cases_joined |>
  select(`Account Number`, 
         `Customer`,
         `Industry`,
         `Case Number`, 
         `Case Title`, 
         `Case Age`, 
         `Case Age (Days)`, 
         `Is Escalated`, 
         everything(),
         -Priority,
         -`Modified On`,
         -Satisfaction,
         -`Sentiment Value`,
         -`Service Level`,
         -SLA,
         -Severity,
         -`Status Reason.y`,
         -`Account Name`,
         -`Account Category`,
         -`Billing Method`,
         -`Billing Frequency`,
         -`Created On.x`,
         -`Account Rating`,
         -Status.y,
         -`Product Name`,
         -`Created On.y`,
         -`Contract Start Date`,
         -`Contract Expiry Date`,
         -`Product Family`,
         -Location,
         -`Accounting Code`,
         -`Status Reason.x`,
         -Lessee) |>
  filter(!grepl("TestPayment", `Account Number`, ignore.case = TRUE)) |>
  filter(!grepl("Waterman Workspaces", `Customer`, ignore.case = TRUE))
```

## Preliminary Analysis

```{r}
summary(cases_joined)
```

```{r}
table(cases_joined$Status.x)
```

```{r}
ggplot(cases_joined, aes(
  x = Status.x, 
  y = `Case Age (Days)`,
  fill = Status.x
)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Case Age by Stats",
       x = "Case Status",
       y = "Case Age (Days)")
```

```{r}
cases_joined |>
  group_by(Status.x) |>
  summarise(Count = n(),
            Mean_Age = mean(`Case Age (Days)`, na.rm = TRUE),
            Prop_Leaving = mean(`Status Reason` == "Off-boarding", na.rm = TRUE))
```

### Remove Outliers

```{r}

Q1 <- quantile(cases_joined$`Case Age (Days)`, 0.25)
Q3 <- quantile(cases_joined$`Case Age (Days)`, 0.75)
IQR <- Q3 - Q1

cases_rmoutlier <- cases_joined |>
  filter(`Case Age (Days)` >= (Q1 - 1.5 * IQR) & `Case Age (Days)` <= (Q3 + 1.5 * IQR))
```


```{r}
ggplot(cases_rmoutlier, aes(
  x = Status.x, 
  y = `Case Age (Days)`,
  fill = Status.x
)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Case Age by Stats",
       x = "Case Status",
       y = "Case Age (Days)")
```

```{r}
cases_rmoutlier |>
  group_by(Status.x) |>
  summarise(Count = n(),
            Mean_Age = mean(`Case Age (Days)`, na.rm = TRUE),
            Prop_Leaving = mean(`Status Reason` == "Off-boarding", na.rm = TRUE))
```

```{r}
glm_model <- lm(`Status Reason` == "Off-boarding" ~ Status.x + `Case Age (Days)` + `Is Escalated`, 
                  data = cases_rmoutlier, family = binomial)
summary(glm_model)

```

```{r}
# Load necessary libraries
library(ggplot2)
library(broom)

# Create a tidy data frame of model coefficients
tidy_glm <- broom::tidy(glm_model)

# Create a coefficient plot
ggplot(tidy_glm, aes(x = estimate, y = term)) +
  geom_point() +
  geom_errorbarh(aes(xmin = estimate - std.error, xmax = estimate + std.error), height = 0.2) +
  labs(title = "Coefficient Plot",
       x = "Estimate",
       y = "Predictor Variables") +
  theme_minimal()

```

```{r}
# Step 1: Filter out rows with missing values in relevant columns
filtered_cases <- cases_rmoutlier %>%
  filter(!is.na(`Status Reason`) & !is.na(Status.x) & !is.na(`Case Age (Days)`) & !is.na(`Is Escalated`))

# Step 2: Fit the model again with the filtered data
glm_model <- glm(`Status Reason` == "Off-boarding" ~ Status.x + `Case Age (Days)` + `Is Escalated`, 
                 data = filtered_cases, family = binomial)

# Step 3: Generate predicted probabilities
filtered_cases$predicted_prob <- predict(glm_model, type = "response")

# Step 4: Create the regression plot
ggplot(filtered_cases, aes(x = `Case Age (Days)`, y = predicted_prob, color = Status.x)) +
  geom_point(alpha = 0.3) +  # Points for actual data
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +  # Logistic regression line
  labs(title = "Logistic Regression Plot",
       x = "Case Age (Days)",
       y = "Predicted Probability of Off-boarding",
       color = "Status") +
  theme_minimal()



```

